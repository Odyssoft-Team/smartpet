-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.breed_catalog (
  id bigint NOT NULL DEFAULT nextval('breed_catalog_id_seq'::regclass),
  species_id bigint NOT NULL,
  name text NOT NULL,
  CONSTRAINT breed_catalog_pkey PRIMARY KEY (id),
  CONSTRAINT breed_catalog_species_id_fkey FOREIGN KEY (species_id) REFERENCES public.species_catalog(id)
);

CREATE TABLE public.cards (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  label text,
  card_holder_name text NOT NULL,
  card_number text NOT NULL,
  expiry_month integer NOT NULL CHECK (expiry_month >= 1 AND expiry_month <= 12),
  expiry_year integer NOT NULL CHECK (expiry_year >= 2024 AND expiry_year <= 2050),
  brand text NOT NULL CHECK (brand = ANY (ARRAY['visa'::text, 'mastercard'::text, 'amex'::text, 'diners'::text, 'discover'::text, 'unknown'::text])),
  is_default boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  cvv text CHECK (length(cvv) <= 4),
  CONSTRAINT cards_pkey PRIMARY KEY (id),
  CONSTRAINT cards_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT fk_cards_user_id FOREIGN KEY (user_id) REFERENCES public.profiles(id)
);

CREATE TABLE public.clinics (
    id uuid NOT NULL DEFAULT gen_random_uuid (),
    name text NOT NULL,
    address text,
    phone text,
    created_at timestamp
    with
        time zone DEFAULT now(),
        CONSTRAINT clinics_pkey PRIMARY KEY (id)
);

CREATE TABLE public.deworming (
    id uuid NOT NULL DEFAULT gen_random_uuid (),
    pet_id bigint NOT NULL,
    applied_at date NOT NULL,
    next_dose_at date,
    notes text,
    created_at timestamp
    with
        time zone DEFAULT now(),
        product_catalog_id bigint,
        CONSTRAINT deworming_pkey PRIMARY KEY (id),
        CONSTRAINT deworming_product_catalog_id_fkey FOREIGN KEY (product_catalog_id) REFERENCES public.deworming_product_catalog (id),
        CONSTRAINT deworming_pet_id_fkey FOREIGN KEY (pet_id) REFERENCES public.pets (id)
);

CREATE TABLE public.deworming_product_catalog (
  id bigint NOT NULL DEFAULT nextval('deworming_product_catalog_id_seq'::regclass),
  name text NOT NULL UNIQUE,
  CONSTRAINT deworming_product_catalog_pkey PRIMARY KEY (id)
);

CREATE TABLE public.district_catalog (
  id bigint NOT NULL DEFAULT nextval('district_catalog_id_seq'::regclass),
  name text NOT NULL UNIQUE,
  is_active boolean DEFAULT true,
  CONSTRAINT district_catalog_pkey PRIMARY KEY (id)
);

CREATE TABLE public.order_options (
    id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
    order_id uuid NOT NULL,
    option_id bigint NOT NULL,
    price numeric DEFAULT 0,
    created_at timestamp
    with
        time zone DEFAULT now(),
        CONSTRAINT order_options_pkey PRIMARY KEY (id),
        CONSTRAINT order_options_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.service_orders (id),
        CONSTRAINT order_options_option_id_fkey FOREIGN KEY (option_id) REFERENCES public.service_options (id)
);

CREATE TABLE public.order_status_logs (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  order_id uuid NOT NULL,
  status text NOT NULL CHECK (status = ANY (ARRAY['requested'::text, 'confirmed'::text, 'en_route'::text, 'in_progress'::text, 'completed'::text, 'cancelled'::text])),
  message text,
  location jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT order_status_logs_pkey PRIMARY KEY (id),
  CONSTRAINT order_status_logs_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.service_orders(id)
);

CREATE TABLE public.pet_services (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  pet_id bigint,
  service_id bigint,
  performed_at timestamp with time zone DEFAULT now(),
  notes text,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'completed'::text, 'cancelled'::text])),
  order_id uuid,
  CONSTRAINT pet_services_pkey PRIMARY KEY (id),
  CONSTRAINT pet_services_pet_id_fkey FOREIGN KEY (pet_id) REFERENCES public.pets(id),
  CONSTRAINT pet_services_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id),
  CONSTRAINT pet_services_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.service_orders(id)
);

CREATE TABLE public.pets (
    id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
    user_id uuid,
    name text NOT NULL,
    weight numeric,
    created_at timestamp
    with
        time zone DEFAULT now(),
        birth_date date,
        updated_at timestamp
    with
        time zone,
        photo_url text,
        social_behavior smallint CHECK (
            social_behavior >= 1
            AND social_behavior <= 5
        ),
        allergies text CHECK (length(allergies) <= 100),
        special_condition text CHECK (
            length(special_condition) <= 20
        ),
        species_id bigint,
        breed_id bigint,
        CONSTRAINT pets_pkey PRIMARY KEY (id),
        CONSTRAINT pets_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles (id),
        CONSTRAINT pets_species_id_fkey FOREIGN KEY (species_id) REFERENCES public.species_catalog (id),
        CONSTRAINT pets_breed_id_fkey FOREIGN KEY (breed_id) REFERENCES public.breed_catalog (id)
);

CREATE TABLE public.profiles (
    id uuid NOT NULL,
    full_name text,
    avatar_url text,
    phone text,
    created_at timestamp
    with
        time zone DEFAULT now(),
        email text UNIQUE CHECK (length(email) <= 50),
        CONSTRAINT profiles_pkey PRIMARY KEY (id),
        CONSTRAINT profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users (id)
);

CREATE TABLE public.revision_status_catalog (
  id bigint NOT NULL DEFAULT nextval('revision_status_catalog_id_seq'::regclass),
  name text NOT NULL UNIQUE,
  CONSTRAINT revision_status_catalog_pkey PRIMARY KEY (id)
);

CREATE TABLE public.revision_type_catalog (
  id bigint NOT NULL DEFAULT nextval('revision_type_catalog_id_seq'::regclass),
  name text NOT NULL UNIQUE,
  CONSTRAINT revision_type_catalog_pkey PRIMARY KEY (id)
);

CREATE TABLE public.revisions (
    id uuid NOT NULL DEFAULT gen_random_uuid (),
    pet_id bigint NOT NULL,
    clinic_id uuid,
    description text,
    created_at timestamp
    with
        time zone DEFAULT now(),
        revision_type_id bigint,
        revision_status_id bigint,
        CONSTRAINT revisions_pkey PRIMARY KEY (id),
        CONSTRAINT revisions_revision_status_id_fkey FOREIGN KEY (revision_status_id) REFERENCES public.revision_status_catalog (id),
        CONSTRAINT revisions_pet_id_fkey FOREIGN KEY (pet_id) REFERENCES public.pets (id),
        CONSTRAINT revisions_clinic_id_fkey FOREIGN KEY (clinic_id) REFERENCES public.clinics (id),
        CONSTRAINT revisions_revision_type_id_fkey FOREIGN KEY (revision_type_id) REFERENCES public.revision_type_catalog (id)
);

CREATE TABLE public.service_options (
    id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
    service_id bigint NOT NULL,
    name text NOT NULL,
    price numeric DEFAULT 0,
    is_active boolean DEFAULT true,
    created_at timestamp
    with
        time zone DEFAULT now(),
        description text CHECK (length(description) <= 50),
        CONSTRAINT service_options_pkey PRIMARY KEY (id),
        CONSTRAINT service_options_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services (id)
);

CREATE TABLE public.service_orders (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  pet_id bigint NOT NULL,
  variant_id bigint,
  card_id uuid,
  scheduled_date date,
  scheduled_time time without time zone,
  total numeric DEFAULT 0,
  payment_status text DEFAULT 'unpaid'::text CHECK (payment_status = ANY (ARRAY['unpaid'::text, 'paid'::text, 'refunded'::text])),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'confirmed'::text, 'in_progress'::text, 'completed'::text, 'cancelled'::text])),
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT service_orders_pkey PRIMARY KEY (id),
  CONSTRAINT service_orders_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id),
  CONSTRAINT service_orders_pet_id_fkey FOREIGN KEY (pet_id) REFERENCES public.pets(id),
  CONSTRAINT service_orders_variant_id_fkey FOREIGN KEY (variant_id) REFERENCES public.service_variants(id),
  CONSTRAINT service_orders_card_id_fkey FOREIGN KEY (card_id) REFERENCES public.cards(id)
);

CREATE TABLE public.service_variants (
    id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
    service_id bigint NOT NULL,
    name text NOT NULL,
    description text,
    price_delta numeric DEFAULT 0,
    is_active boolean DEFAULT true,
    created_at timestamp
    with
        time zone DEFAULT now(),
        CONSTRAINT service_variants_pkey PRIMARY KEY (id),
        CONSTRAINT service_variants_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services (id)
);

CREATE TABLE public.services (
    id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
    name text NOT NULL,
    description text,
    price numeric,
    duration_minutes integer,
    created_at timestamp
    with
        time zone DEFAULT now(),
        is_active boolean DEFAULT true,
        CONSTRAINT services_pkey PRIMARY KEY (id)
);

CREATE TABLE public.species_catalog (
  id bigint NOT NULL DEFAULT nextval('species_catalog_id_seq'::regclass),
  name text NOT NULL UNIQUE,
  CONSTRAINT species_catalog_pkey PRIMARY KEY (id)
);

CREATE TABLE public.user_addresses (
    id uuid NOT NULL DEFAULT gen_random_uuid (),
    user_id uuid NOT NULL,
    alias text CHECK (length(alias) <= 50),
    address text NOT NULL,
    reference text CHECK (length(reference) <= 100),
    district_id bigint NOT NULL,
    is_default boolean DEFAULT false,
    created_at timestamp
    with
        time zone DEFAULT now(),
        CONSTRAINT user_addresses_pkey PRIMARY KEY (id),
        CONSTRAINT user_addresses_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles (id),
        CONSTRAINT user_addresses_district_id_fkey FOREIGN KEY (district_id) REFERENCES public.district_catalog (id)
);

CREATE TABLE public.vaccine_catalog (
  id bigint NOT NULL DEFAULT nextval('vaccine_catalog_id_seq'::regclass),
  name text NOT NULL UNIQUE,
  CONSTRAINT vaccine_catalog_pkey PRIMARY KEY (id)
);

CREATE TABLE public.vaccines (
    id uuid NOT NULL DEFAULT gen_random_uuid (),
    pet_id bigint NOT NULL,
    applied_at date NOT NULL,
    next_dose_at date,
    notes text,
    created_at timestamp
    with
        time zone DEFAULT now(),
        vaccine_catalog_id bigint,
        CONSTRAINT vaccines_pkey PRIMARY KEY (id),
        CONSTRAINT vaccines_vaccine_catalog_id_fkey FOREIGN KEY (vaccine_catalog_id) REFERENCES public.vaccine_catalog (id),
        CONSTRAINT vaccines_pet_id_fkey FOREIGN KEY (pet_id) REFERENCES public.pets (id)
);